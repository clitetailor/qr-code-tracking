<svelte:component this="{comp}"></svelte:component>

<script>
  import { usePage } from './utils/page'
  import { checkAuth } from './graphql/auth'

  import Home from './pages/index/index.html'
  import Login from './pages/login/login.html'
  import Signup from './pages/signup/signup.html'
  import Dashboard from './pages/dashboard/dashboard.html'
  import Edit from './pages/edit/edit.html'
  import Detail from './pages/detail/detail.html'
  import QRCode from './pages/qrcode/qrcode.html'

  let comp

  const page = usePage()

  page('/', () => {
    ifAuthed(() => {
      comp = Home
    })
  })
  page('/login', () => {
    ifAuthed(() => {
      comp = Login
    })
  })
  page('/signup', () => {
    ifAuthed(() => {
      comp = Signup
    })
  })

  page('/dashboard', () => {
    ifNotAuthed(() => {
      comp = Dashboard
    })
  })
  page('/edit*', () => {
    ifNotAuthed(() => {
      comp = Edit
    })
  })
  page('/detail/*', () => {
    ifNotAuthed(() => {
      comp = Detail
    })
  })
  page('/qrcode/*', () => {
    comp = QRCode
  })

  async function ifNotAuthed(callback) {
    const authStatus = await checkAuth()

    if (authStatus.ok) {
      callback()
    } else {
      page('/')
    }
  }

  async function ifAuthed(callback) {
    const authStatus = await checkAuth()

    if (!authStatus.ok) {
      callback()
    } else {
      page('/dashboard')
    }
  }
</script>
