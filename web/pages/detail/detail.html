<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
  <header class="mdl-layout__header">
    <div
      class="mdl-layout__drawer-button"
      on:click="{() => page('/dashboard')}"
    >
      <i class="material-icons">arrow_back</i>
    </div>
    <div class="mdl-layout__header-row">
      <span class="mdl-layout-title">New</span>
    </div>
  </header>
  <main class="mdl-layout__content">
    <HereMap bind:this="{hereMap}"></HereMap>
    {#each trackingInfos as trackingInfo}
    <div>
      <span>Longitude: {trackingInfo.longitude}</span>
      <span>Latitude: {trackingInfo.latitude}</span>
    </div>
    {/each}
  </main>
</div>

<style>
  .c-qrcode__form {
    width: 100%;
    height: 100%;
    display: flex;
    flex-flow: column nowrap;
    align-items: center;
    justify-content: flex-start;
  }
</style>

<script>
  import { onDestroy } from 'svelte'

  import HereMap from '../shared/here-map.html'

  import { loadMdl } from '../../utils/mdl'
  import { usePage } from '../../utils/page'
  import {
    getTrackingInfos,
    trackingInfoAdded
  } from '../../graphql/trackinginfo'

  loadMdl()
  const page = usePage()

  let trackingInfos = []
  let hereMap

  const subscriptions = {}

  page('/detail/:id', async context => {
    const qrcodeId = parseInt(context.params.id)

    trackingInfos = await getTrackingInfos(qrcodeId)

    hereMap.initMarkers(trackingInfos)

    subscriptions.trackingInfoAdded = trackingInfoAdded(
      qrcodeId
    ).subscribe(trackingInfo => {
      trackingInfos.push(trackingInfo)
      hereMap.addMarker(trackingInfo)

      trackingInfos = trackingInfos
    })
  })

  onDestroy(() => {
    subscriptions.trackingInfoAdded.unsubscribe()
  })
</script>
